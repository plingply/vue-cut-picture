!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.vueCutPicture=i()}(this,function(){"use strict";var t={template:'<div> <div class="cut_imgbox" ref="cut_imgbox" @touchend="carboxup($event)" @mouseup="carboxup($event)"> <div class="cut_left"> <div class="cut_box" ref="cut_box"> <img id="caijianimg" :src="imgurl" alt ref="caijianimg"> <div class="cut_catbox" ref="cut_carbox" @touchstart="carboxdown($event)" @touchend="carboxup($event)" @touchmove="carboxmove($event)" @mousedown="carboxdown($event)" @mouseup="carboxup($event)" @mousemove="carboxmove($event)"> <div class="cut_model cut_model1"></div> <div class="cut_model cut_model2"></div> <div class="cut_model cut_model3"></div> <div class="cut_model cut_model4"></div> <div class="cut_point cut_point1"></div> <div class="cut_point cut_point3"></div> <div class="cut_point cut_point5"></div> <div class="cut_point cut_point7"></div> </div> </div> </div> </div> <div ref="yulanimg" style="display:none"></div> <div class="cut_loading" v-show="loading">图片加载中...</div> <div class="cut_btn_box"> <button @click="cancelfun" class="cancelstyle" v-show="cancelShow">{{ confirmText }}</button> <button @click="confirmfun" class="confirmstyle" v-show="confirmShow">{{ cancelText }}</button> </div> </div>',props:{height:{type:String,default:"200px"},width:{type:String,default:"100%"},cutwidth:{type:String,default:"200px"},cutheight:{type:String,default:"100px"},url:{required:!0},cancelShow:{type:Boolean,default:!0},cancelText:{type:String,default:"确认裁剪"},confirmShow:{type:Boolean,default:!0},compress:{type:Boolean,default:!1},confirmText:{type:String,default:"取消"}},data:function(){return{isClick:!1,isclick1:!1,point_className:"",oldx:0,oldy:0,imgurl:"",shx:1,loading:!1}},watch:{url:function(t){this.loading=!0;var i=this,e=this.$refs.cut_carbox.clientWidth,s=new FileReader;s.readAsDataURL(t),s.onload=function(){if(i.compress){var t=new Image;t.src=this.result,t.onload=function(){i.imgurl=i.compressImg(t),i.$refs.caijianimg.style.maxWidth=i.width,i.$refs.caijianimg.style.minWidth=e+"px",i.$refs.caijianimg.style.maxHeight=i.height,setTimeout(function(){i.setCatboxposition()})}}else i.imgurl=this.result,i.$refs.caijianimg.style.maxWidth=i.width,i.$refs.caijianimg.style.minWidth=e+"px",i.$refs.caijianimg.style.maxHeight=i.height,setTimeout(function(){i.setCatboxposition()})}}},methods:{compressImg:function(t){var i,e,s=document.createElement("canvas"),l=s.getContext("2d"),c=document.createElement("canvas"),n=c.getContext("2d"),o=t.width,a=t.height;if((i=o*a/4e6)>1?(o/=i=Math.sqrt(i),a/=i):i=1,s.width=o,s.height=a,l.fillStyle="#fff",l.fillRect(0,0,s.width,s.height),(e=o*a/1e6)>1){var h=~~(o/(e=~~(Math.sqrt(e)+1))),d=~~(a/e);c.width=h,c.height=d;for(var u=0;u<e;u++)for(var r=0;r<e;r++)n.drawImage(t,u*h*i,r*d*i,h*i,d*i,0,0,h,d),l.drawImage(c,u*h,r*d,h,d)}else l.drawImage(t,0,0,o,a);var f=s.toDataURL("image/jpeg",.3);return c.width=c.height=s.width=s.height=0,f},setBoxsize:function(){var t=this.$refs.cut_imgbox;t.style.width=this.width,t.style.height=this.height},setCatboxposition:function(){var t=this.$refs.cut_box,i=this.$refs.cut_carbox,e=t.clientHeight,s=t.clientWidth;i.style.width=this.cutwidth,i.style.height=this.cutheight;var l=i.clientHeight,c=i.clientWidth,n=(s-c)/2<0?0:(s-c)/2,o=(e-l)/2<0?0:(e-l)/2;i.style.top=o+"px",i.style.left=n+"px",document.querySelectorAll(".cut_model").forEach(function(t){t.style.height=e+"px",-1!=t.className.indexOf("cut_model1")&&(t.style.width=s+"px",t.style.height=3*e+"px",t.style.left=-1*s+"px",t.style.top=-1*(3*e-l)/2+"px"),-1!=t.className.indexOf("cut_model2")&&(t.style.width="100%",t.style.left="0px",t.style.top=-1*e+"px"),-1!=t.className.indexOf("cut_model3")&&(t.style.width=s+"px",t.style.height=3*e+"px",t.style.left="100%",t.style.top=-1*(3*e-l)/2+"px"),-1!=t.className.indexOf("cut_model4")&&(t.style.left="0",t.style.width="100%",t.style.top="100%")}),i.style.opacity=1,this.loading=!1},carboxdown:function(t){t.preventDefault(),this.point_className=t.target.className,"cut_catbox"==t.target.className&&(this.isClick=!0,this.oldx=t.clientX?t.clientX:t.touches[0].clientX,this.oldy=t.clientY?t.clientY:t.touches[0].clientY),-1!=t.target.className.indexOf("cut_point")&&(this.oldx=t.clientX?t.clientX:t.touches[0].clientX,this.oldy=t.clientY?t.clientY:t.touches[0].clientY,this.isclick1=!0)},carboxup:function(){this.isClick=!1,this.isclick1=!1},carboxmove:function(t){var i=this.$refs.cut_box,e=this.$refs.cut_carbox,s=i.clientHeight,l=i.clientWidth,c=e.clientHeight,n=e.clientWidth,o=t.clientX?t.clientX:t.touches[0].clientX,a=t.clientY?t.clientY:t.touches[0].clientY,h=this.oldx-o,d=this.oldy-a;if(!(Math.abs(h)<4&&Math.abs(d)<4)){if(this.isClick){var u=o-this.oldx,r=a-this.oldy,f=parseFloat(e.style.left),m=parseFloat(e.style.top);(f+u>=0&&f+u<l-n||f+u<f&&f+u>=0)&&(e.style.left=f+u+"px",this.oldx=o),(m+r>=0&&m+r<s-c||m+r>=0&&m+r<m)&&(e.style.top=m+r+"px",this.oldy=a)}if(this.isclick1){var p=e.clientWidth;u=parseFloat(e.style.left),r=parseFloat(e.style.top);if(-1!=this.point_className.indexOf("cut_point1")){var x=p+h;if((x>l||x/this.shx>s)&&x>p||x<50&&x<p)return;e.style.width=x+"px",e.style.height=x/this.shx+"px",e.style.left=u-h+"px",e.style.top=r-h/this.shx+"px",this.oldx=o,this.oldy=a}if(-1!=this.point_className.indexOf("cut_point3")){var g=p-h;if((g>l||g/this.shx>s)&&g>p||g<50&&g<p)return;e.style.width=g+"px",e.style.height=g/this.shx+"px",e.style.top=r+h/this.shx+"px",this.oldx=o}if(-1!=this.point_className.indexOf("cut_point5")){var y=p-h;if((y>l||y/this.shx>s)&&y>p||y<50&&y<p)return;e.style.width=p-h+"px",e.style.height=y/this.shx+"px",this.oldx=o}if(-1!=this.point_className.indexOf("cut_point7")){var v=p+h;if((v>l||v/this.shx>s)&&v>p||v<50&&v<p)return;e.style.width=v+"px",e.style.height=v/this.shx+"px",e.style.left=u-h+"px",this.oldx=o}}}},catImg:function(t,i,e,s){var l=document.createElement("canvas");l.id="cut_canvas",l.width=t,l.height=i,l.style.width=this.cutwidth,l.style.height=this.cutheight,this.$refs.yulanimg.innerHTML="",this.$refs.yulanimg.appendChild(l);var c=l.getContext("2d"),n=this.$refs.caijianimg;c.drawImage(n,-1*e,-1*s,2*n.width,2*n.height),this.upload()},confirmfun:function(){if(""!=this.imgurl){var t=this.$refs.cut_carbox,i=2*t.clientWidth,e=2*t.clientHeight,s=2*parseFloat(t.style.left),l=2*parseFloat(t.style.top);this.catImg(i,e,s,l)}else alert("请选择图片")},cancelfun:function(){this.$emit("cancelfun"),this.$refs.yulanimg.innerHTML="",this.imgurl=""},upload:function(){var t=document.getElementById("caijianimg"),i=document.getElementById("cut_canvas");if(i){var e=t.src.substr(t.src.lastIndexOf(".")).substr(1),s=i.toDataURL(e);this.$emit("uploadfile",{base64:s}),s=null,this.$refs.yulanimg.innerHTML="",this.imgurl=""}else alert("请先裁剪图片")}},mounted:function(){this.setBoxsize();var t=this;this.shx=parseInt(this.cutwidth)/parseInt(this.cutheight),window.addEventListener("mouseup",function(){t.isClick=!1,t.isclick1=!1})},install:function(i,e){void 0===e&&(e="vueCutPicture"),i.component(e,t)}};return t});
